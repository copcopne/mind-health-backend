<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/extras/spring-security">

<head>
    <title>Quản lý phản hồi</title>
    <th:block th:replace="~{base :: styles}"></th:block>
</head>

<body class="d-flex flex-column vh-100">
    <div th:replace="~{base :: header}"></div>

    <main style="margin-top: 58px">
        <div class="container pt-4" th:object="${feedbacks}">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <h2 class="mb-0">Quản lý phản hồi</h2>
                <div class="text-muted small">
                    Tổng <span th:text="*{totalElements}">0</span> phản hồi —
                    Trang <span th:text="*{page + 1}">1</span>/<span th:text="*{totalPages}">1</span>
                </div>
            </div>

            <form th:action="@{/feedbacks}" method="get" class="row g-2 align-items-center mb-3">

                <!-- Trái: ô tìm kiếm + nút thêm dính nhau -->
                <div class="col-12 col-lg-6">
                    <div class="input-group">
                        <input type="text" class="form-control" name="keyword"
                            placeholder="Tìm theo nội dung phản hồi..." th:value="${param.keyword}">

                        <!-- Nút XÓA: chỉ hiện khi có keyword -->
                        <button type="button" class="btn btn-outline-secondary" data-mdb-ripple-init
                            th:if="${not #strings.isEmpty(param.keyword)}"
                            onclick="const f=this.closest('form'); f.keyword.value=''; f.page.value=0; f.submit();">
                            Đặt lại tìm kiếm
                        </button>
                    </div>
                </div>

                <!-- Giữa: combobox chọn loại phản hồi -->
                <div class="col-12 col-lg-3">
                    <div class="d-flex align-items-center gap-2">
                        <label class="mb-0 text-nowrap">Loại phản hồi</label>
                        <select class="form-select w-auto" name="type"
                            onchange="this.form.page.value=0; this.form.submit()">
                            <option value="" th:selected="${#lists.isEmpty(param.type)}">Tất cả</option>

                            <option value="MOOD_ENTRY"
                                th:selected="${param.type != null and #lists.contains(param.type, 'MOOD_ENTRY')}">
                                MOOD_ENTRY
                            </option>

                            <option value="MESSAGE"
                                th:selected="${param.type != null and #lists.contains(param.type, 'MESSAGE')}">
                                MESSAGE
                            </option>
                        </select>

                    </div>
                </div>

                <!-- Phải: chọn kích thước trang -->
                <div class="col-12 col-lg-3">
                    <div class="d-flex align-items-center justify-content-lg-end justify-content-start gap-2">
                        <label class="mb-0 text-nowrap">Kích thước trang</label>
                        <select class="form-select w-auto" name="size"
                            onchange="this.form.page.value=0; this.form.submit()">
                            <option th:value="5" th:selected="*{size} == 5">5</option>
                            <option th:value="10" th:selected="*{size} == 10">10</option>
                            <option th:value="20" th:selected="*{size} == 20">20</option>
                            <option th:value="50" th:selected="*{size} == 50">50</option>
                        </select>
                    </div>
                </div>

                <!-- Khi tìm kiếm/đổi size/type thì reset về trang 0 -->
                <input type="hidden" name="page" value="0" />
            </form>




            <!-- Bảng người dùng -->
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>ID người dùng</th>
                                    <th>ID phản hồi</th>
                                    <th>Loại phản hồi</th>
                                    <th>Nội dung phản hồi</th>
                                    <th>Phân loại phản hồi</th>
                                    <th>Trạng thái</th>
                                    <th class="text-end">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="f, stat : *{content}"
                                    th:classappend="${!f.read} ? 'table-warning border-start border-1 border-warning-subtle unread-row'">
                                    <td th:text="${feedbacks.page * feedbacks.size + stat.index + 1}">1</td>
                                    <td th:text="${f.user.id}">NaN</td>
                                    <td th:text="${f.targetId}">NaN</td>
                                    <td><span class="badge bg-secondary" th:text="${f.targetType}">TYPE</span></td>

                                    <td>
                                        <span class="d-inline-block text-truncate align-middle"
                                            style="max-width: 420px;" th:text="${f.content}"
                                            th:attr="title=${f.content}">
                                            content
                                        </span>
                                    </td>

                                    <td><span class="badge bg-primary" th:text="${f.satisfyLevel.label}">TYPE</span>
                                    </td>

                                    <td>
                                        <span th:if="${f.read}" class="badge bg-success">Đã đọc</span>
                                        <span th:if="${!f.read}" class="badge bg-danger">Chưa đọc</span>
                                    </td>

                                    <!-- Thao tác -->
                                    <td class="text-end d-flex gap-2 justify-content-end">
                                        <a class="btn btn-sm btn-primary"
                                            th:href="@{'/feedbacks/' + ${f.id}}">Xem chi tiết</a>
                                    </td>
                                </tr>
                                <tr th:if="*{content} == null or *{content.isEmpty()}">
                                    <td colspan="11" class="text-center text-muted py-4">Không có dữ liệu.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Phân trang -->
            <nav aria-label="Pagination" class="mt-3" th:if="*{totalPages > 0}">
                <ul class="pagination mb-0">
                    <li class="page-item" th:classappend="!*{hasPrevious} ? 'disabled'">
                        <a class="page-link"
                            th:href="@{/feedbacks(page=*{page - 1}, size=*{size}, keyword=${param.keyword},  type=${param.type})}">Prev</a>
                    </li>

                    <!-- Hiển thị một ít số trang; đơn giản: current-2 .. current+2 -->
                    <li class="page-item"
                        th:each="p : ${#numbers.sequence(T(java.lang.Math).max(0, feedbacks.page - 2), T(java.lang.Math).min(feedbacks.totalPages - 1, feedbacks.page + 2))}"
                        th:classappend="${p} == *{page} ? 'active'">
                        <a class="page-link" th:text="${p + 1}"
                            th:href="@{/feedbacks(page=${p}, size=${feedbacks.size}, keyword=${param.keyword}, type=${param.type})}">1</a>

                    </li>

                    <li class="page-item" th:classappend="!*{hasNext} ? 'disabled'">
                        <a class="page-link"
                            th:href="@{/feedbacks(page=*{page + 1}, size=*{size}, keyword=${param.keyword}, type=${param.type})}">Next</a>
                    </li>
                </ul>
            </nav>
        </div>

    </main>



    <div th:replace="~{base :: mdb_script}"></div>
    <div th:replace="~{base :: main_scripts}"></div>
</body>

</html>